function startIntro(){var t=introJs();t.setOptions({tooltipClass:"intro-tooltip",steps:[{intro:"Welcome to SDStreets, an explorer of the street work City of San Diego is up to."},{element:"label.sidebar-toggle",intro:"Click this icon to see the available views.",position:"right"},{element:"div.cartodb-zoom",intro:"Use the zoom control to zoom or out of the map.  You can also drag the map to pan.",position:"left"},{element:"#bottom-bar-tab",intro:"When you're looking at a view, extra metrics will come up here.  If you don't want to see them, click on the blue bar and they will dissapear.",position:"top"},{element:"i.question-help",intro:"Click on the ? to learn more!",position:"left"}]}),t.start()}var sqlBuilder=function(){var t={ic:{cartodb_id:"ic.cartodb_id",the_geom:"ic.the_geom",the_geom_webmercator:"ic.the_geom_webmercator",activity:"ic.asset_type",street:"ic.rd20full",from_street:"ic.xstrt1",to_street:"ic.xstrt2",status:"ic.project_st",length:"(ic.shape_len / 5280)",adj_length:"getSQLString",moratorium:"ic.moratorium",work_start:"ic.start_cons",work_completed:"to_char(ic.moratorium, 'Month YYYY')",work_scheduled:"getSQLString",work_end:"ic.moratorium"},tswb:{width:"tswb.width"},oci2011:{cartodb_id:"oci2011.cartodb_id",the_geom:"oci2011.the_geom",the_geom_webmercator:"oci2011.the_geom_webmercator",oci_date:"oci2011.oci_date",street:"oci2011.street",from_street:"oci2011.from_street",to_street:"oci2011.to_street",oci_condition:"getSQLString",color:"getSQLString",length:"oci2011.length",oci:"oci2011.oci",oci_display:"ROUND(oci2011.oci)"}},e={ic:"imcat_street",tswb:"tsw_basemap",oci2011:"oci_2011_master"};return getLastQuarter=function(){var t=t||new Date,e="YYYY-MM-DD",o=moment(t).month()%3+1,a=moment(t).subtract({months:o}).endOf("month"),i=a.clone().subtract({months:3}).startOf("month");return{start:i.format(e),end:a.format(e)}},select=function(){return squel.select({fieldAliasQuoteCharacter:"",tableAliasQuoteCharacter:""})},getSQLString=function(t){switch(t){case"adj_length":var e=mapAlias("tswb","width"),o=mapAlias("ic","length");return"CASE WHEN "+e+" >= 48 THEN ("+o+" * 2) ELSE "+o+" END";case"oci_condition":case"color":return"CASE WHEN oci <= 39.999 THEN 'Poor' WHEN oci <= 69.999 THEN 'Fair' ELSE 'Good' END";case"work_scheduled":var a=mapAlias("ic","work_start");return"CASE WHEN EXTRACT (MONTH FROM  "+a+") >= 7 THEN 'FY-' || EXTRACT (YEAR FROM "+a+") + 1 ELSE 'FY-' || EXTRACT (YEAR FROM "+a+") END";default:throw new Error("Unfound getSQLString "+t)}},mapAlias=function(o,a){if(-1===_.indexOf(_.keys(e),o))throw new Error("No Table "+o);if(_.isUndefined(a))return e[o];if(_.isUndefined(t[o][a]))throw new Error("Unfound Table "+o+" Field "+a);return"getSQLString"===t[o][a]?getSQLString(a):t[o][a]},getTableSQL=function(o){var a=select();return"oci-2011"==o?(_.each(t.oci2011,function(t,e){a.field(mapAlias("oci2011",e),e)}),a.from(mapAlias("oci2011"),"oci2011")):(_.each(t.ic,function(t,e){a.field(mapAlias("ic",e),e)}),_.each(t.tswb,function(t,e){a.field(mapAlias("tswb",e),e)}),a.from(e.ic,"ic").join(e.tswb,"tswb","ic.sapid = tswb.sapid")),a},getConditionSQL=function(t,e){var o=getLastQuarter();switch(t){case"all-work":e.where(mapAlias("ic","work_end")+" is not null").where(mapAlias("ic","status")+" = 'Moratorium'").where(mapAlias("ic","work_end")+"::date >= '2013-07-01'").where(mapAlias("ic","work_end")+"::date <= '"+o.end+"'");break;case"work-1k-pledge":e.where(mapAlias("ic","work_end")+" is not null").where(mapAlias("ic","status")+" = 'Moratorium'").where(mapAlias("ic","work_end")+"::date >= '2015-07-01'").where(mapAlias("ic","work_end")+"::date <= '"+o.end+"'");break;case"work-fy-2014":e.where(mapAlias("ic","work_end")+" is not null").where(mapAlias("ic","status")+" = 'Moratorium'").where(mapAlias("ic","work_end")+"::date >= '2013-07-01'").where(mapAlias("ic","work_end")+"::date <= '2014-06-30'");break;case"work-fy-2015":e.where(mapAlias("ic","work_end")+" is not null").where(mapAlias("ic","status")+" = 'Moratorium'").where(mapAlias("ic","work_end")+"::date >= '2014-07-01'").where(mapAlias("ic","work_end")+"::date <= '2015-06-30'");break;case"work-fy-2016":e.where(mapAlias("ic","work_end")+" is not null").where(mapAlias("ic","status")+" = 'Moratorium'").where(mapAlias("ic","work_end")+"::date >= '2015-07-01'").where(mapAlias("ic","work_end")+"::date <= '"+o.end+"'");break;case"future-work":e.where(mapAlias("ic","work_end")+" is null").where(mapAlias("ic","status")+" = 'Planning' OR "+mapAlias("ic","status")+" = 'Awarding' OR "+mapAlias("ic","status")+" = 'Construction'");break;case"oci-2011":e.where("oci_date is not null").where("oci > 0").where("oci_date::date <= '2012-01-01'")}return e},getDistanceSQL=function(t,e){var o=select(),a="";return e.groupFieldSQL&&(a=e.groupFieldSQL),e.groupFieldAlias&&(a=mapAlias(e.tableAlias,e.groupFieldAlias)),o.field(a,e.groupFieldAlias).field("SUM("+mapAlias(e.tableAlias,e.lengthFieldAlias)+")","totalMiles").group(a),"oci-2011"==t?o.from(mapAlias("oci2011"),"oci2011"):o.from(mapAlias("ic"),"ic").join(mapAlias("tswb"),"tswb","ic.sapid = tswb.sapid"),e.order&&o.order(a,"ASC"==e.order),o},getOCICalcSQL=function(t,e){var o=select();if("avg"==e){mapAlias("oci2011","oci"),mapAlias("oci2011","length");o.field("SUM(OCI * LENGTH) / SUM(LENGTH)","avg")}return o.from(mapAlias("oci2011"),"oci2011"),o},{getSQL:function(t){var e=getTableSQL(t);return getConditionSQL(t,e).toString()},getLastQuarter:function(t){return getLastQuarter(t)},getDistanceSQL:function(t,e){var o=getDistanceSQL(t,e);return o=getConditionSQL(t,o).toString()},mapAlias:function(t,e){return mapAlias(t,e)},getOCICalcSQL:function(t,e){var o=getOCICalcSQL(t,e);return o=getConditionSQL(t,o).toString(),console.log(o),o}}}(),opsControl=function(){return sql=new cartodb.SQL({user:"cityofsandiego"}),tDistanceStringConfig={tableAlias:"ic",groupFieldAlias:"activity",lengthFieldAlias:"adj_length"},getTDistance=function(t,e){var o=sqlBuilder.getDistanceSQL(t,tDistanceStringConfig);sql.execute(o).done(function(o){opsDisplay[e](t,o)})},{progress:function(t){return getTDistance(t,"progress")},calcTDistance:function(t){return getTDistance(t,"calcTDistance")},typeBreakdown:function(t){return getTDistance(t,"typeBreakdown")},totalMiles:function(t){return getTDistance(t,"totalMiles")},ociBreakdown:function(t){var e=sqlBuilder.getDistanceSQL(t,{tableAlias:"oci2011",groupFieldAlias:"color",lengthFieldAlias:"length",order:"ASC"});sql.execute(e).done(function(e){opsDisplay.ociBreakdown(t,e),opsDisplay.totalMiles(t,e)})},ociAvg:function(t){var e=sqlBuilder.getOCICalcSQL(t,"avg");sql.execute(e).done(function(e){opsDisplay.ociAvg(t,e)})},workByMonth:function(t){var e=sqlBuilder.getDistanceSQL(t,{tableAlias:"ic",groupFieldSQL:"to_char("+sqlBuilder.mapAlias("ic","work_end")+", 'MM')",lengthFieldAlias:"adj_length",order:"ASC"});sql.execute(e).done(function(e){opsDisplay.workByMonth(t,e)})},bigNumbers:function(t,e){var o=sqlBuilder.getDistanceSQL(t,{tableAlias:"ic",groupFieldSQL:"to_char("+sqlBuilder.mapAlias("ic","work_end")+", 'MM-YY')",lengthFieldAlias:"adj_length",order:"ASC"});sql.execute(o).done(function(e){opsDisplay.totalMiles(t,e),opsDisplay.avgMilesPerMonth(t,e)})}}}(),opsDisplay=function(){return colors={oci:{good:"#0098db",fair:"#fcd900",poor:"#ffa02f"},activity:{overlay:"#0098db",slurry:"#ffa02f",concrete:"#fcd900"}},{calcTDistance:function(t,e){$(".tDistance","#helper_box #"+t).text(_.sum(e.rows,function(t){return t.totalmiles}).toFixed(0))},typeBreakdown:function(t,e){chartData=[];console.log(e),_.each(e.rows,function(t,e){chartData.push([t.activity,t.totalmiles])}),$("#chart-title-1 h4").text("Work Type Breakdown"),window.typeBreakdownChart=c3.generate({bindto:"#chart-container-1",data:{type:"pie",columns:chartData,colors:{Slurry:colors.activity.slurry,Overlay:colors.activity.overlay,Concrete:colors.activity.concrete}},pie:{label:{format:function(t,e,o){return d3.format("%")(e)}}},tooltip:{format:{name:function(t,e,o,a){return t},value:function(t,e,o,a){return d3.round(t,0)+" Miles"}}}})},workByMonth:function(t,e){chartX={},chartData={},_.each(e.rows,function(t,e){var o=parseInt(t.to_char);o>=7?(chartX[o-7]=t.to_char,chartData[o-7]=d3.round(t.totalmiles,0)):(chartX[o+6]=t.to_char,chartData[o+6]=d3.round(t.totalmiles,0))}),chartX=_.values(chartX),chartData=_.values(chartData),chartX.splice(0,0,"x"),chartData.splice(0,0,"miles"),$("#chart-title-2 h4").text("Work By Month"),window.workByMonthChart=c3.generate({bindto:"#chart-container-2",data:{x:"x",type:"bar",columns:[chartX,chartData]},color:{pattern:["#0098db"]},bar:{width:{ratio:.5}},legend:{hide:!0},tooltip:{grouped:!1,format:{title:function(t){var e=chartX[t+1];return moment(e,"M").format("MMM")+" Total"},name:function(t,e,o,a){return t.charAt(0).toUpperCase()+t.slice(1)}}},axis:{x:{type:"category",tick:{culling:!1,format:function(t){return moment(chartX[t+1],"M").format("MMM")}}},y:{label:{text:"Miles",position:"inner-top"}}}})},progress:function(t,e){var o=_.sum(e.rows,function(t){return t.totalmiles}).toFixed(2),a=[];a.push(["Total Distance",o]),window.progressChart=c3.generate({bindto:"#chart-container-2",size:{height:215},data:{type:"gauge",columns:a},gauge:{max:1e3,width:20,units:" miles",label:{format:function(t,e){return d3.round(t,0)},show:!0}}})},ociBreakdown:function(t,e){chartData=[],_.each(e.rows,function(t,e){chartData.push([t.color,t.totalmiles])}),$("#chart-title-1 h4").text("OCI Breakdown"),window.typeBreakdownChart=c3.generate({bindto:"#chart-container-1",data:{type:"pie",columns:chartData,colors:{Poor:colors.oci.poor,Fair:colors.oci.fair,Good:colors.oci.good}},pie:{label:{format:function(t,e,o){return d3.format("%")(e)}}},tooltip:{format:{name:function(t,e,o,a){return t},value:function(t,e,o,a){return d3.round(t,0)+" Miles"}}}})},totalMiles:function(t,e){totalMiles=_.sum(e.rows,function(t){return t.totalmiles}),totalMiles=d3.round(totalMiles,0),targetBox=$("#helper_box #bignum-left"),$(".data-value",targetBox).text(totalMiles),$(".data-desc",targetBox).text("Miles"),$("#helper_box .bignum-left").show()},ociAvg:function(t,e){ociAvg=d3.round(_.first(e.rows).avg,0),targetBox=$("#helper_box #bignum-right"),$(".data-value",targetBox).text(ociAvg),$(".data-desc",targetBox).text("Average OCI"),$("#helper_box .bignums").show()},avgMilesPerMonth:function(t,e){totalMiles=_.sum(e.rows,function(t){return t.totalmiles}),avgMilesPerMonth=d3.round(totalMiles/e.rows.length,0),targetBox=$("#helper_box #bignum-right"),$(".data-value",targetBox).text(avgMilesPerMonth),$(".data-desc",targetBox).text("Avg Miles Per Month"),$("#helper_box .bignums").show()}}}(),global={workLayers:{}},viewController={init:function(){var t=this;cartodb.createVis("map","https://cityofsandiego.cartodb.com/api/v2/viz/0eb76b2a-50ea-11e5-b297-0e018d66dc29/viz.json",{tiles_loader:!0,center_lat:32.715,center_lon:-117.1625,zoom:11}).done(function(e,o){$("body").removeClass(".map-loading").addClass("map-loaded"),global.vis=e,global.layers=o,global.map=e.getNativeMap(),t.initSubLayerWatch(),t.initBottomBar(),t.initModalLinks(),t.initLocationLinks(),t.initFirstLayer(),t.initIntro()}).error(function(t){console.log(t)})},initLocationLinks:function(){var t=this;$("a#find-me-link").click(function(e){return t.detectUserLocation(),!1}),$("form#address-search").submit(function(e){return address=$("input",this).val(),t.getAddressLocation(address),!1})},initModalLinks:function(){var t=this;$("a.modal-link").click(function(e){var o=$(this).attr("href"),a=$(this);return $(o).modal({backdrop:!0}),$(o).one("shown.bs.modal",function(){t.showModalAndHighlight(a)}),!1})},initFirstLayer:function(){$("#layer-selector a#all-work").click()},showModalAndHighlight:function(t){var e=$(t).data("modal-show"),o=$(t).attr("href");$(".modal-body span").removeClass("modal-highlighted-section"),e&&(e="#"+e,$(e,o).addClass("modal-highlighted-section"))},initSubLayerWatch:function(){viewController.clearState();var t=$("#layer-selector a.layer-opt");t.click(function(e){var o=$(e.target);$("#sidebar-checkbox").prop("checked",!1),t.removeClass("active"),$(o).addClass("active"),viewController.loadMapInfo(o),viewController.executeOps(o)})},initBottomBar:function(){$("#bottom-bar .tab").click(viewController.bottomBarToggle)},initIntro:function(t){var t=t||!1,e=this.getCookie("sdInfraIntro");(null==e||""==e||1==t)&&(this.setCookie("sdInfraIntro","1",90),$("a#help-link").click())},getCookie:function(t){for(var e=t+"=",o=document.cookie.split(";"),a=0;a<o.length;a++){for(var i=o[a];" "==i.charAt(0);)i=i.substring(1);if(-1!=i.indexOf(e))return i.substring(e.length,i.length)}return""},setCookie:function(t,e,o){var a=new Date;a.setTime(a.getTime()+24*o*60*60*1e3);var i="expires="+a.toUTCString();document.cookie=t+"="+e+"; "+i},clearState:function(){$("#helper_box").hide(),$("#helper_box .helper_section").hide(),$("#helper_box .bignums").hide();for(var t=global.layers[1].getSubLayerCount(),e=0;t>e;e++)global.layers[1].getSubLayer(e).hide();$(".chart-title h4").text(""),window.typeBreakdownChart&&(window.typeBreakdownChart=window.typeBreakdownChart.destroy()),window.progressChart&&(window.progressChart=window.progressChart.destroy()),window.workByMonthChart&&(window.workByMonthChart=window.workByMonthChart.destroy())},mapToPosition:function(t){lon=t.coords.longitude,lat=t.coords.latitude,this.geoLocMarker&&global.map.removeLayer(this.geoLocMarker),this.geoLocMarker=new L.CircleMarker([lat,lon],{radius:7,color:"#00549f",opacity:1,fill:!0,fillOpacity:.8}),this.geoLocMarker.addTo(global.map),global.map.setView(new L.LatLng(lat,lon),15)},loadMapInfo:function(t){var e=t.attr("data-sublayer"),o=t.attr("data-sql"),a=t.attr("id");this.clearState();var i=global.layers[1].getSubLayer(e);if(1==o){var r=sqlBuilder.getSQL(a);console.log("Set Map Query For Layer: "+a+" with Number "+e),console.log(r),i.setSQL(r)}i.show(),$("#helper_box #"+a+".helper_section").show(),$("#helper_box").show()},executeOps:function(t){var e=t.data("ops").split(",")||null;if(e){_.each(e,function(e,o){opsControl[e]($(t).attr("id"))}),$("#bottom-bar-content #blank-intro").remove();var o=sqlBuilder.getLastQuarter();$(".lqEnd").text(moment(o.end).format("MMMM D, YYYY"));$("#layer-selector a.active").html();this.bottomBarToggle("open")}},bottomBarToggle:function(t){var e=$("#layer-selector a.active").html(),o=unescape(' <i class="fa fa-chevron-up"></i> '),a=unescape(' <i class="fa fa-chevron-down"></i> '),t="string"==typeof t?t:null;null!==t&&"close"==t||null===t&&$("#bottom-bar .tab").hasClass("active")?($("#bottom-bar").animate({bottom:-$("#bottom-bar .tab-content").height()}),$("#bottom-bar .tab").removeClass("active").html(o+e+o),$(".sidebar-navbar-collapse").addClass("in")):($("#bottom-bar").animate({bottom:0}),$("#bottom-bar .tab").addClass("active").html(a+e+a),$(".sidebar-navbar-collapse").removeClass("in"))},getAddressLocation:function(t){var e=this;$.get("https://pickpoint.io/api/v1/forward?key=XYjMsMG9CXK6mq57Z_vG",{q:t,countrycodes:"us",addressdetails:"1",limit:"1",bounded:"1",viewbox:["-67.956039","10.27012","-67.941757","10.25608"]}).success(function(t){loc=_.first(t),e.mapToPosition({coords:{longitude:loc.lon,latitude:loc.lat}})})},detectUserLocation:function(){var t=this;if(navigator.geolocation){var e=1e7;navigator.geolocation.getCurrentPosition(t.mapToPosition,t.alertError,{enableHighAccuracy:!0,timeout:e,maximumAge:0})}else alert("Geolocation is not supported by this browser")},alertError:function(t){var e={1:"Permission denied",2:"Position unavailable",3:"Request timeout"};alert("Error: "+e[t.code])}};$(document).ready(function(){$.reject({reject:{msie:10},imagePath:"./assets/images/browsers/",display:["chrome","firefox"],header:"You Internet Browser is not compatible with SDStreets!",paragraph1:"Because of this, various things may not work. Please see the list of compatible browsers below. ",paragraph2:"Just click on the icons to get to the download page!"}),viewController.init()});